<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>長照契約自動生成系統 (專用版2.0)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 引入必要的函式庫 (unpkg) -->
    <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.js"></script>
    <script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <script src="https://unpkg.com/docxtemplater@3.40.0/build/docxtemplater.js"></script>
    
    <!-- 引入字體圖示 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #ffffff; }
        .step-card { @apply bg-white p-6 rounded-xl shadow-md border-2 border-transparent transition-all mb-6; }
        .step-card.active { @apply border-green-500 shadow-lg; }
        .input-group { @apply mb-4; }
        .input-label { @apply block text-sm font-bold text-gray-700 mb-1; }
        .input-field { @apply w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none transition; }
        .btn-primary { @apply bg-green-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-green-700 transition shadow-md disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center gap-2; }
        .btn-secondary { @apply bg-gray-100 text-gray-700 px-4 py-2 rounded-lg font-medium hover:bg-gray-200 transition; }
        .btn-danger { @apply bg-red-100 text-red-600 px-2 py-1 rounded hover:bg-red-200 transition text-xs; }
        
        /* 表格樣式 */
        .service-table { @apply w-full text-sm text-left text-gray-500; }
        .service-table th { @apply text-xs text-gray-700 uppercase bg-gray-100 px-2 py-2; }
        .service-table td { @apply px-2 py-2 border-b; }
        .service-input { @apply w-full p-1 border border-gray-300 rounded focus:ring-1 focus:ring-green-500; }
    </style>
</head>
<body class="min-h-screen py-8 px-4 max-w-6xl mx-auto">

    <!-- Header -->
    <div class="text-center mb-8">
        <h1 class="text-3xl md:text-4xl font-bold text-green-800 mb-2">
            <i class="fa-solid fa-file-contract"></i> 嘉豐-長照契約自動生成系統
        </h1>
        <p class="text-green-600">自動計算 • 智慧填入 • 自由編輯</p>
    </div>

    <div class="grid grid-cols-1 gap-6">
        
        <!-- Step 1: 檔案上傳 -->
        <div class="step-card active" id="step1">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <span class="bg-green-100 text-green-800 w-8 h-8 rounded-full flex items-center justify-center mr-2 text-sm">1</span>
                上傳檔案
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="relative group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">契約範例 (Word .docx)</label>
                    <label class="flex flex-col items-center justify-center w-full h-24 border-2 border-green-300 border-dashed rounded-lg cursor-pointer bg-green-50 hover:bg-green-100 transition">
                        <div class="flex flex-col items-center justify-center">
                            <i class="fa-solid fa-file-word text-green-500 text-2xl mb-1"></i>
                            <p class="text-xs text-gray-500" id="wordFileName">點擊上傳 Word 範本</p>
                        </div>
                        <input id="wordInput" type="file" class="hidden" accept=".docx" />
                    </label>
                </div>

                <div class="relative group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">個案資料 (HTML)</label>
                    <label class="flex flex-col items-center justify-center w-full h-24 border-2 border-blue-300 border-dashed rounded-lg cursor-pointer bg-blue-50 hover:bg-blue-100 transition">
                        <div class="flex flex-col items-center justify-center">
                            <i class="fa-brands fa-html5 text-blue-500 text-2xl mb-1"></i>
                            <p class="text-xs text-gray-500" id="htmlFileName">點擊上傳 個案 HTML</p>
                        </div>
                        <input id="htmlInput" type="file" class="hidden" accept=".html,.htm" />
                    </label>
                </div>
            </div>
        </div>

        <!-- Step 2: 資料編輯與確認 (合併預覽與手動輸入) -->
        <div class="step-card opacity-50 pointer-events-none" id="step2">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <span class="bg-green-100 text-green-800 w-8 h-8 rounded-full flex items-center justify-center mr-2 text-sm">2</span>
                資料編輯與確認 <span class="ml-2 text-sm font-normal text-gray-500">(請在此核對並修改資料)</span>
            </h2>
            
            <!-- A. 基本資料區 -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 bg-gray-50 p-4 rounded-lg border border-gray-200">
                <div class="input-group">
                    <label class="input-label">個案姓名 {name_o}</label>
                    <input type="text" id="name_o" class="input-field bg-gray-100" readonly>
                </div>
                <div class="input-group">
                    <label class="input-label">身分證號 {Code_o}</label>
                    <input type="text" id="Code_o" class="input-field bg-gray-100" readonly>
                </div>
                <div class="input-group">
                    <label class="input-label">個案編號 {num}</label>
                    <input type="text" id="num" class="input-field" placeholder="請手動輸入">
                </div>

                <!-- 可編輯的聯絡資訊 -->
                <div class="input-group">
                    <label class="input-label text-blue-700"><i class="fa-solid fa-pen"></i> 聯絡人姓名 {name_f}</label>
                    <input type="text" id="name_f" class="input-field bg-white" placeholder="可編輯">
                </div>
                <div class="input-group">
                    <label class="input-label text-blue-700"><i class="fa-solid fa-pen"></i> 聯絡電話 {Phone_f}</label>
                    <input type="text" id="Phone_f" class="input-field bg-white" placeholder="可編輯">
                </div>
                <div class="input-group md:col-span-1">
                    <label class="input-label text-blue-700"><i class="fa-solid fa-pen"></i> 聯絡地址 {address_live}</label>
                    <input type="text" id="address_live" class="input-field bg-white" placeholder="可編輯 (已嘗試過濾里鄰)">
                </div>

                <!-- 其他 -->
                <div class="input-group">
                    <label class="input-label">家訪日期 {Visit_D}</label>
                    <input type="date" id="visitDate" class="input-field">
                </div>
                <div class="input-group md:col-span-2">
                    <label class="input-label">主責督導 {manager}</label>
                    <select id="manager" class="input-field">
                        <option value="">請選擇督導...</option>
                        <option value="吳玉婷/0968-687-696">吳玉婷/0968-687-696</option>
                        <option value="謝坤達/0970-353-380">謝坤達/0970-353-380</option>
                        <option value="王香涵/0902-371-397">王香涵/0902-371-397</option>
                        <option value="廖玟婷/0970-361-881">廖玟婷/0970-361-881</option>
                    </select>
                </div>
            </div>

            <!-- B. 金額資訊 (唯讀) -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 p-4 bg-yellow-50 rounded-lg border border-yellow-200 text-sm">
                <div><span class="text-gray-500 block">B碼額度</span> <span id="disp_BA" class="font-bold text-lg">0</span></div>
                <div><span class="text-gray-500 block">G碼額度</span> <span id="disp_GA" class="font-bold text-lg">0</span></div>
                <div><span class="text-gray-500 block">部分負擔</span> <span id="disp_part" class="font-bold text-red-600 text-lg">0</span></div>
                <div><span class="text-gray-500 block">福利身分</span> <span id="disp_welfare" class="font-bold text-blue-600">一般戶</span></div>
            </div>

            <!-- C. 照顧服務 (B碼) 表格 - 可編輯 -->
            <div class="mb-8">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-bold text-green-800 text-lg">1. 照顧服務 (B碼) - 附件四第一表格</h3>
                    <button onclick="addBRow()" class="btn-secondary text-xs"><i class="fa-solid fa-plus"></i> 新增項目</button>
                </div>
                <div class="overflow-x-auto border rounded-lg">
                    <table class="service-table" id="tableB">
                        <thead>
                            <tr>
                                <th class="w-48">服務項目</th>
                                <th class="w-24">單價(元)</th>
                                <th class="w-24">部分負擔費用(元)</th>
                                <th class="w-32">服務頻率(次/週或次/月)</th>
                                <th class="w-32">費用總計(元/週或元/月)</th>
                                <th class="w-32">備註</th>
                                <th class="w-10">操作</th>
                            </tr>
                        </thead>
                        <tbody id="tbodyB">
                            <!-- JS 動態產生 -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- D. 喘息服務 (G碼) 表格 - 可編輯 -->
            <div class="mb-6">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-bold text-orange-800 text-lg">2. 喘息服務 (G碼) - 附件四第二表格</h3>
                    <button onclick="addGRow()" class="btn-secondary text-xs"><i class="fa-solid fa-plus"></i> 新增項目</button>
                </div>
                <div class="overflow-x-auto border rounded-lg">
                    <table class="service-table" id="tableG">
                        <thead>
                            <tr>
                                <th class="w-48">服務項目</th>
                                <th class="w-24">單價(元)</th>
                                <th class="w-24">部分負擔費用(元)</th>
                                <th class="w-32">服務頻率(次/週或次/月)</th>
                                <th class="w-32">費用總計(元/週或元/月)</th>
                                <th class="w-32">備註</th>
                                <th class="w-10">操作</th>
                            </tr>
                        </thead>
                        <tbody id="tbodyG">
                            <!-- JS 動態產生 -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Step 3: 生成按鈕 -->
            <button id="generateBtn" class="btn-primary w-full text-lg py-4 shadow-xl" disabled onclick="generateContract()">
                <i class="fa-solid fa-wand-magic-sparkles"></i> 立即生成契約 Word
            </button>
        </div>
    </div>

    <script>
        let globalData = {};
        let wordFileContent = null;

        // 1. Word 上傳
        document.getElementById('wordInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('wordFileName').textContent = file.name;
                const reader = new FileReader();
                reader.onload = function(evt) {
                    wordFileContent = evt.target.result;
                    checkReady();
                };
                reader.readAsBinaryString(file);
            }
        });

        // 2. HTML 上傳
        document.getElementById('htmlInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('htmlFileName').textContent = file.name;
                const reader = new FileReader();
                reader.onload = function(evt) {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(evt.target.result, "text/html");
                    parseHtmlData(doc);
                    
                    // 啟用編輯區
                    document.getElementById('step2').classList.remove('opacity-50', 'pointer-events-none');
                    document.getElementById('step2').classList.add('active');
                    checkReady();
                };
                reader.readAsText(file);
            }
        });

        function checkReady() {
            if (wordFileContent && document.getElementById('name_o').value) {
                document.getElementById('generateBtn').disabled = false;
            }
        }

        // 3. 解析與填入 (核心邏輯)
        function parseHtmlData(doc) {
            const findVal = (text) => {
                const ths = Array.from(doc.querySelectorAll('th, td'));
                const found = ths.find(el => el.innerText.includes(text));
                return found && found.nextElementSibling ? found.nextElementSibling.innerText.trim() : "";
            };

            // 基本資料
            let name_o = findVal("個案姓名").replace("傳統姓名", "").trim();
            let code_o = findVal("個案身分證").split(' ')[0].trim();
            
            // 修正標題抓取 fallback
            if (!name_o) {
                const titleDiv = Array.from(doc.querySelectorAll('div')).find(d => d.innerText.includes("個案姓名/身分證字號"));
                if (titleDiv) {
                    const parts = titleDiv.innerText.split('：')[1].split('/');
                    name_o = parts[0].trim();
                    code_o = parts[1].trim().split('\n')[0];
                }
            }

            // 地址處理：自動過濾 "鄰" 與 "里/村"
            let rawAddress = findVal("居住(通訊)地址");
            let cleanAddress = rawAddress.replace(/\d+鄰/g, '');
            cleanAddress = cleanAddress.replace(/(\S+?[里村])(?=[^縣市區鄉鎮]|$)/g, ''); 
            cleanAddress = rawAddress.replace(/\d+鄰/g, '').replace(/\S+[里村]/g, (match) => {
                return ""; 
            });

            // 聯絡人與電話
            let name_f = findVal("主要聯絡人姓名") || findVal("代理人姓名") || findVal("聯絡人姓名");
            let phone_f = findVal("聯絡人手機") || findVal("代理人手機");

            // 金額與身分處理 (修正邏輯)
            let BA = "0";
            let GA = "0";
            let part = "0";

            const headers = Array.from(doc.querySelectorAll('th'));

            // 1. 抓取 [照顧及專業服務] 區塊 (包含 B碼額度 和 民眾部份負擔)
            const bHeader = headers.find(th => th.innerText.includes("照顧及專業服務"));
            if (bHeader && bHeader.nextElementSibling) {
                const text = bHeader.nextElementSibling.innerText;
                
                // 抓取 BA 額度
                const matchBA = text.match(/給付額度[：:]\s*(\d+)/);
                if (matchBA) BA = matchBA[1];

                // 抓取 部分負擔 (修正：從同一格文字中抓取)
                // 嘗試抓取完整格式：數字元(16%)
                const matchPart = text.match(/民眾部份負擔[：:]\s*([0-9,]+元(?:\s*[(\uff08].*?[)\uff09])?)/);
                if (matchPart) {
                    part = matchPart[1];
                } else {
                    // Fallback: 只抓數字
                    const matchPartNum = text.match(/民眾部份負擔[：:]\s*([0-9,]+)/);
                    if (matchPartNum) part = matchPartNum[1];
                }
            }

            // 2. 抓取 [喘息服務] 區塊 (G碼額度)
            const gHeader = headers.find(th => th.innerText.includes("喘息服務"));
            if (gHeader && gHeader.nextElementSibling) {
                const text = gHeader.nextElementSibling.innerText;
                const matchGA = text.match(/給付額度[：:]\s*(\d+)/);
                if (matchGA) GA = matchGA[1];
            }

            // 費率判斷
            const welfareRow = findVal("長照福利身份");
            let rate = 0.16;
            if (welfareRow.includes("第一類")) rate = 0;
            else if (welfareRow.includes("第二類")) rate = 0.05;

            // 填入 UI (可編輯區)
            document.getElementById('name_o').value = name_o;
            document.getElementById('Code_o').value = code_o;
            document.getElementById('address_live').value = cleanAddress;
            document.getElementById('name_f').value = name_f;
            document.getElementById('Phone_f').value = phone_f;

            // 填入 UI (唯讀區)
            document.getElementById('disp_BA').textContent = BA;
            document.getElementById('disp_GA').textContent = GA;
            document.getElementById('disp_part').textContent = part;
            document.getElementById('disp_welfare').textContent = welfareRow;

            // 儲存費率供計算用
            globalData = { BA, GA, part, rate };

            // 產生表格 (B & G)
            generateTableFromHtml(doc, 'qd110ListDivB', 'tbodyB', rate, '次/月');
            generateTableFromHtml(doc, 'qd110ListDivG', 'tbodyG', rate, '次/年');
        }

        // 從 HTML 抓取表格資料並填入 Input
        function generateTableFromHtml(doc, divId, tbodyId, rate, unit) {
            const tbody = document.getElementById(tbodyId);
            tbody.innerHTML = ""; // 清空

            const div = doc.getElementById(divId);
            if (!div) return;

            const rows = div.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                // 根據你提供的 HTML，表格欄位大約是: [0]項次 [1]服務項目 [2]金額 [3]數量 [4]小計
                if (cells.length >= 4) {
                    const codeRaw = cells[1].innerText.trim(); // "BA13[陪同外出]"
                    
                    // --- 關鍵修正：確保移除後方多餘括號，保留完整中文名稱 ---
                    // 目標: "BA13[陪同外出]" -> "BA13陪同外出"
                    // 目標: "BA14[陪同就醫](10712)" -> "BA14陪同就醫"
                    
                    let code = codeRaw.split('[')[0]; // Fallback
                    const nameMatch = codeRaw.match(/^([A-Za-z0-9]+)\[([^\]]+)\]/);
                    if (nameMatch) {
                        // 格式: BA13 + 陪同外出 -> BA13陪同外出 (自動忽略後面的 (10712))
                        code = nameMatch[1] + nameMatch[2];
                    }
                    // --- 修改結束 ---

                    const priceStr = cells[2].innerText.replace(/[^\d.]/g, '');
                    const price = parseFloat(priceStr);
                    const qty = parseInt(cells[3].innerText.replace(/[^\d]/g, ''));
                    const total = cells[4].innerText.replace(/[^\d.]/g, '');
                    const selfPay = Math.floor(price * rate);

                    if (code && !isNaN(price)) {
                        addServiceRow(tbodyId, code, price, selfPay, `${qty} ${unit}`, total);
                    }
                }
            });
        }

        // 新增一行 (通用)
        function addServiceRow(tbodyId, code = "", price = "", selfPay = "", freq = "", total = "") {
            const tbody = document.getElementById(tbodyId);
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="text" class="service-input code" value="${code}"></td>
                <td><input type="number" class="service-input price" value="${price}" onchange="calcRow(this)"></td>
                <td><input type="number" class="service-input self-pay" value="${selfPay}"></td>
                <td><input type="text" class="service-input freq" value="${freq}"></td>
                <td><input type="text" class="service-input total" value="${total}"></td>
                <td><input type="text" class="service-input note" value=""></td>
                <td class="text-center">
                    <button onclick="this.closest('tr').remove()" class="btn-danger"><i class="fa-solid fa-trash"></i></button>
                </td>
            `;
            tbody.appendChild(tr);
        }

        // 包裝函式
        function addBRow() { addServiceRow('tbodyB', '', '', '', '次/月', ''); }
        function addGRow() { addServiceRow('tbodyG', '', '', '', '次/年', ''); }

        // 簡單計算功能 (當修改單價時)
        function calcRow(input) {
            const tr = input.closest('tr');
            const price = parseFloat(input.value) || 0;
            // 這裡可以加入自動計算自付額的邏輯，如果需要的話
            // const selfPayInput = tr.querySelector('.self-pay');
            // selfPayInput.value = Math.floor(price * globalData.rate);
        }

        // 4. 生成 Word
        function generateContract() {
            if (!wordFileContent) return;

            // 收集基本資料
            const inputDate = document.getElementById('visitDate').value;
            let formattedDate = "   年   月   日";
            if (inputDate) {
                const d = new Date(inputDate);
                const rocYear = d.getFullYear() - 1911;
                formattedDate = `${rocYear}年 ${String(d.getMonth()+1).padStart(2,'0')}月 ${String(d.getDate()).padStart(2,'0')}日`;
            }

            const data = {
                num: document.getElementById('num').value,
                name_o: document.getElementById('name_o').value,
                Code_o: document.getElementById('Code_o').value,
                address_live: document.getElementById('address_live').value, // 使用編輯過的地址
                name_f: document.getElementById('name_f').value,             // 使用編輯過的聯絡人
                Phone_f: document.getElementById('Phone_f').value,           // 使用編輯過的電話
                Visit_D: formattedDate,
                manager: document.getElementById('manager').value,
                BA: globalData.BA,
                GA: globalData.GA,
                part: globalData.part,
                
                // 收集表格資料
                b_list: getTableData('tbodyB'),
                g_list: getTableData('tbodyG')
            };

            try {
                const zip = new window.PizZip(wordFileContent);
                const doc = new window.docxtemplater(zip, { paragraphLoop: true, linebreaks: true });
                doc.render(data);
                const out = doc.getZip().generate({
                    type: "blob",
                    mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
                });
                saveAs(out, `${data.name_o}_長照契約.docx`);
            } catch (error) {
                alert("生成失敗: " + error.message);
                console.error(error);
            }
        }

        function getTableData(tbodyId) {
            const rows = document.getElementById(tbodyId).querySelectorAll('tr');
            return Array.from(rows).map(row => ({
                code: row.querySelector('.code').value,
                price: row.querySelector('.price').value,
                self_pay: row.querySelector('.self-pay').value,
                freq: row.querySelector('.freq').value,
                total: row.querySelector('.total').value,
                note: row.querySelector('.note').value
            }));
        }
    </script>
</body>
</html>